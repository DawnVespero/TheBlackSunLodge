/*
THIS IS A GENERATED/BUNDLED FILE BY ESBUILD.
If you want to view the source, visit the plugin's github repository:
https://github.com/kometenstaub/metadata-extractor

The plugin is MIT-licensed:

    MIT License

    Copyright (c) 2021-2022 kometenstaub

    Permission is hereby granted, free of charge, to any person obtaining a copy
    of this software and associated documentation files (the "Software"), to deal
    in the Software without restriction, including without limitation the rights
    to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
    copies of the Software, and to permit persons to whom the Software is
    furnished to do so, subject to the following conditions:

    The above copyright notice and this permission notice shall be included in all
    copies or substantial portions of the Software.

    THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
    IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
    FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
    AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
    LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
    OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
    SOFTWARE.

*/

"use strict";var k=Object.defineProperty;var P=Object.getOwnPropertyDescriptor;var N=Object.getOwnPropertyNames;var I=Object.prototype.hasOwnProperty;var E=(l,a)=>{for(var e in a)k(l,e,{get:a[e],enumerable:!0})},L=(l,a,e,t)=>{if(a&&typeof a=="object"||typeof a=="function")for(let i of N(a))!I.call(l,i)&&i!==e&&k(l,i,{get:()=>a[i],enumerable:!(t=P(a,i))||t.enumerable});return l};var A=l=>L(k({},"__esModule",{value:!0}),l);var q={};E(q,{default:()=>y});module.exports=A(q);var O=require("obsidian");var c=require("obsidian"),v=require("fs");function C(l){let a=new Blob([l],{type:"text/javascript"}),e=URL.createObjectURL(a),t=new Worker(e);return URL.revokeObjectURL(e),t}function S(){return C(`self.onmessage=function(l){let c=l.data[0],i=l.data[1],s=c;c.forEach(n=>{let f=n.fileName,k=n.relativePath;s.forEach(t=>{f!==t.fileName&&t.links&&t.links.forEach(a=>{let e={};a.relativePath===k&&(e.fileName=t.fileName,e.link=a.link,e.relativePath=t.relativePath,a.cleanLink&&(e.cleanLink=a.cleanLink),a.displayText&&(e.displayText=a.displayText),i.push(e))})}),i.length>0&&(n.backlinks=i),i=[]}),self.postMessage(c)};
`)}function T(l,a){let e=[];for(let i of a)i.name.slice(-3)!==".md"&&e.push(i);return j(l,e)}function j(l,a){let e={};return a.length>0?Object.assign(e,{folders:l,nonMdFiles:a}):Object.assign(e,{folders:l}),e}function J(l){let a=[],e=[];for(let t of l)t instanceof c.TFolder?a.push({name:t.name,relativePath:t.path}):t instanceof c.TFile&&e.push({name:t.name,basename:t.basename,relativePath:t.path});return{folders:a,files:e}}var F=class{constructor(a,e){this.plugin=a,this.app=e}getAbsolutePath(a){let e;if(this.app.vault.adapter instanceof c.FileSystemAdapter)e=this.app.vault.adapter.getBasePath();else throw new Error("Cannot determine base path.");let t=`${this.app.vault.configDir}/plugins/metadata-extractor/${a}`;return`${e}/${t}`}getUniqueTags(a){let e=[],t=(0,c.getAllTags)(a);return t&&(e=t),e=e.map(i=>i.slice(1).toLowerCase()),e=Array.from(new Set(e)),e}writeAllExceptMd(a){let e=this.plugin.settings.allExceptMdPath;this.plugin.settings.allExceptMdPath||(e=this.getAbsolutePath(a));let t=this.app.vault.getAllLoadedFiles(),{folders:i,files:h}=J(t),r=T(i,h);(0,v.writeFileSync)(e,JSON.stringify(r,null,2)),this.plugin.settings.consoleLog&&console.log("Metadata Extractor plugin: wrote the allExceptMd JSON file")}writeCanvases(a){let e=this.plugin.settings.canvasPath;this.plugin.settings.canvasPath||(e=this.getAbsolutePath(a));let t=this.app.vault.getAllLoadedFiles(),i=[];for(let h of t)h instanceof c.TFile&&h.extension==="canvas"&&i.push({name:h.name,basename:h.basename,relativePath:h.path});(0,v.writeFileSync)(e,JSON.stringify(i,null,2)),this.plugin.settings.consoleLog&&console.log("Metadata Extractor plugin: wrote the canvas JSON file")}createCleanFrontmatter(a){let e=Object.assign({},a);return e.aliases&&delete e.aliases,e.tags&&delete e.tags,e}writeTagsToJSON(a){let e=this.app.metadataCache.getTags();if(Object.keys(e).length===0){let n="There are no tags in your vault.";if(this.plugin.settings.consoleLog){console.log(n);return}else return}let t=this.plugin.settings.tagPath;this.plugin.settings.tagPath||(t=this.getAbsolutePath(a));let i=[];for(let n of this.app.vault.getMarkdownFiles()){let o,s=this.app.metadataCache.getFileCache(n);s&&(o=s);let g=n.path,m=this.getUniqueTags(o);m.length!==0&&i.push({name:g,tags:m})}let r=i.map(n=>n.tags).reduce((n,o)=>n.concat(o.map(s=>s.toLowerCase()))),f=Array.from(new Set(r)),w=this.app.metadataCache.getTags(),u={};for(let[n,o]of Object.entries(w)){let s=n.slice(1).toLowerCase();u[s]=o}let p=[];for(let n of f){let o=[];for(let g of i)g.tags.contains(n)&&o.push(g.name);let s=u[n];p.push({tag:n,tagCount:s,relativePaths:o})}(0,v.writeFileSync)(t,JSON.stringify(p,null,2)),this.plugin.settings.consoleLog&&console.log("Metadata Extractor plugin: wrote the tagToFile JSON file")}writeCacheToJSON(a){let e=this.plugin.settings.metadataPath;this.plugin.settings.metadataPath||(e=this.getAbsolutePath(a));let t=[];for(let r of this.app.vault.getMarkdownFiles()){let f=r.basename,w=r.path,u,p=this.app.metadataCache.getFileCache(r);if(p)u=p;else{this.plugin.settings.consoleLog&&console.log(`No cache for file: ${r.path}`);continue}let n,o=[],s={};s.fileName=f,s.relativePath=w;let g=this.getUniqueTags(u);g&&g.length>0&&(s.tags=g),u.frontmatter&&(s.frontmatter=this.createCleanFrontmatter(u.frontmatter),n=(0,c.parseFrontMatterAliases)(u.frontmatter),n&&n.length>0&&(s.aliases=n)),u.headings&&(u.headings.forEach(b=>{o.push({heading:b.heading,level:b.level})}),s.headings=o);let m=D(u,s,w,f,this.app,r);Object.assign(s,m),Object.keys(s).length>0&&t.push(s)}let i=[],h=S();h.postMessage([t,i]),h.onerror=r=>{new c.Notice("Something went wrong with the backlinks calculation.")},h.onmessage=r=>{t=r.data,(0,v.writeFileSync)(e,JSON.stringify(t,null,2)),this.plugin.settings.consoleLog&&console.log("Metadata Extractor plugin: wrote the metadata JSON file"),h.terminate()}}setWritingSchedule(a,e,t,i){if(this.plugin.settings.writingFrequency!=="0"){let r=parseInt(this.plugin.settings.writingFrequency)*6e4;window.clearInterval(this.plugin.intervalId1),this.plugin.intervalId1=void 0,this.plugin.intervalId1=window.setInterval(()=>this.writeTagsToJSON(a),r),this.plugin.registerInterval(this.plugin.intervalId1),window.clearInterval(this.plugin.intervalId2),this.plugin.intervalId2=void 0,this.plugin.intervalId2=window.setInterval(()=>this.writeCacheToJSON(e),r),this.plugin.registerInterval(this.plugin.intervalId2),window.clearInterval(this.plugin.intervalId3),this.plugin.intervalId3=void 0,this.plugin.intervalId3=window.setInterval(()=>this.writeAllExceptMd(t),r),this.plugin.registerInterval(this.plugin.intervalId3),window.clearInterval(this.plugin.intervalId4),this.plugin.intervalId4=void 0,this.plugin.intervalId4=window.setInterval(()=>this.writeCanvases(i),r),this.plugin.registerInterval(this.plugin.intervalId4)}else this.plugin.settings.writingFrequency==="0"&&(window.clearInterval(this.plugin.intervalId1),window.clearInterval(this.plugin.intervalId2),window.clearInterval(this.plugin.intervalId3),window.clearInterval(this.plugin.intervalId4))}};function D(l,a,e,t,i,h){let r=[],f=[];w();function w(){let p=[],n=[];l.links&&(p=l.links),l.embeds&&(n=l.embeds.filter(o=>{let s=o.link,g=(0,c.getLinkpath)(s);if(i.metadataCache.getFirstLinkpathDest(g,h.path))return o})),f=p.concat(n),u()}function u(){for(let p of f){let n=p.link,o="",s={};typeof p.displayText!="undefined"&&(o=p.displayText);let g=i.metadataCache.getFirstLinkpathDest((0,c.getLinkpath)(n),h.path);if(!(g&&g.path.slice(-3).toLowerCase()!==".md")){if(n.includes("/")&&(n=n.split("/").last()),!n.includes("#"))s.link=n,o!==n&&(s.displayText=o),g&&(s.relativePath=g.path);else if(n.includes("#")&&n.charAt(0)!=="#"){let m=o,b=(0,c.getLinkpath)(n);s.link=n,s.cleanLink=b,(!o.includes("#")||!o.includes(">"))&&(s.displayText=m),g&&(s.relativePath=g.path)}else n.charAt(0)==="#"&&(s.link=n,s.relativePath=e,s.cleanLink=t,n!==o&&(s.displayText=o));r.push(s)}}r.length>0&&(a.links=r)}return a}var d=require("obsidian"),M={tagPath:"",metadataPath:"",allExceptMdPath:"",canvasPath:"",tagFile:"tags.json",metadataFile:"metadata.json",allExceptMdFile:"allExceptMd.json",canvasFile:"canvas.json",writingFrequency:"0",writeFilesOnLaunch:!1,consoleLog:!1},x=class extends d.PluginSettingTab{constructor(e,t){super(e,t);this.plugin=t}display(){let{containerEl:e}=this;e.empty(),e.createEl("h2",{text:"Metadata Extractor Settings"}),new d.Setting(e).setName("File-write path for tags").setDesc("Where the tag-to-file-names JSON file will be saved. Requires the file name with extension. 			If this is filled in, the setting below won't have any effect.").addText(t=>t.setPlaceholder("/home/user/Downloads/tags.json").setValue(this.plugin.settings.tagPath).onChange(async i=>{this.plugin.settings.tagPath=i,await this.plugin.saveSettings()})),new d.Setting(e).setName("File name of tag-to-file-names JSON").setDesc("Requires the .json extension. 			Only change this setting if you want to change the name of the saved json in the plugin folder.").addText(t=>t.setPlaceholder("tags.json").setValue(this.plugin.settings.tagFile).onChange(async i=>{this.plugin.settings.tagFile=i,await this.plugin.saveSettings()})),new d.Setting(e).setName("File-write path for metadata").setDesc("Where the metadata JSON file will be saved. Requires the file name with extension. 			If this is filled in, the setting below won't have any effect.").addText(t=>t.setPlaceholder("/home/user/Downloads/metadata.json").setValue(this.plugin.settings.metadataPath).onChange(async i=>{this.plugin.settings.metadataPath=i,await this.plugin.saveSettings()})),new d.Setting(e).setName("File name of metadata JSON").setDesc("Requires the .json extension; leave empty if setting above was changed. 			Only change this setting if you want to change the name of the saved json in the plugin folder.").addText(t=>t.setPlaceholder("metadata.json").setValue(this.plugin.settings.metadataFile).onChange(async i=>{this.plugin.settings.metadataFile=i,await this.plugin.saveSettings()})),new d.Setting(e).setName("File-write path for canvases").setDesc("Where the canvas JSON file will be saved. Requires the file name with extension. 			If this is filled in, the setting below won't have any effect.").addText(t=>t.setPlaceholder("/home/user/Downloads/canvas.json").setValue(this.plugin.settings.canvasPath).onChange(async i=>{this.plugin.settings.canvasPath=i,await this.plugin.saveSettings()})),new d.Setting(e).setName("File name of canvas JSON").setDesc("Requires the .json extension; leave empty if setting above was changed. 			Only change this setting if you want to change the name of the saved json in the plugin folder.").addText(t=>t.setPlaceholder("canvas.json").setValue(this.plugin.settings.canvasFile).onChange(async i=>{this.plugin.settings.canvasFile=i,await this.plugin.saveSettings()})),new d.Setting(e).setName("File-write path of allExceptMd JSON").setDesc("Where the allExceptMd JSON file will be saved. Requires the file name with extension. 			If this is filled in, the setting below won't have any effect.").addText(t=>t.setPlaceholder("/home/user/Downloads/allExceptMd.json").setValue(this.plugin.settings.allExceptMdPath).onChange(async i=>{this.plugin.settings.allExceptMdPath=i,await this.plugin.saveSettings()})),new d.Setting(e).setName("File name of allExceptMd JSON").setDesc("Requires the .json extension; leave empty if setting above was changed. 			Only change this setting if you want to change the name of the saved json in the plugin folder.").addText(t=>t.setPlaceholder("metadata.json").setValue(this.plugin.settings.allExceptMdFile).onChange(async i=>{this.plugin.settings.allExceptMdFile=i,await this.plugin.saveSettings()})),new d.Setting(e).setName("Configure frequency for writing the three JSON files").setDesc("The frequency has to be entered in minutes. Set it to 0 to disable the periodic writing.").addText(t=>t.setPlaceholder("120").setValue(this.plugin.settings.writingFrequency).onChange(async i=>{i===""?this.plugin.settings.writingFrequency="0":this.plugin.settings.writingFrequency=i,await this.plugin.saveSettings(),this.plugin.methods.setWritingSchedule(this.plugin.settings.tagFile,this.plugin.settings.metadataFile,this.plugin.settings.allExceptMdFile,this.plugin.settings.canvasFile)})),new d.Setting(e).setName("Write JSON files automatically when Obsidian launches").setDesc("If enabled, the JSON files will be written each time Obsidian starts.").addToggle(t=>{t.setValue(this.plugin.settings.writeFilesOnLaunch).onChange(i=>{this.plugin.settings.writeFilesOnLaunch=i,this.plugin.saveSettings()})}),new d.Setting(e).setName("Show console logs").setDesc("Only enable this for debugging purposes.").addToggle(t=>{t.setValue(this.plugin.settings.consoleLog).onChange(i=>{this.plugin.settings.consoleLog=i,this.plugin.saveSettings()})})}};var y=class extends O.Plugin{constructor(){super(...arguments);this.intervalId1=void 0;this.intervalId2=void 0;this.intervalId3=void 0;this.intervalId4=void 0;this.methods=new F(this,this.app)}async onload(){console.log("loading Metadata Extractor plugin"),await this.loadSettings(),this.addCommand({id:"write-tags-json",name:"Write JSON file with tags and associated file names to disk.",callback:()=>{this.methods.writeTagsToJSON(this.settings.tagFile)}}),this.addCommand({id:"write-metadata-json",name:"Write JSON file with metadata to disk.",callback:()=>{this.methods.writeCacheToJSON(this.settings.metadataFile)}}),this.addCommand({id:"write-allExceptMd-json",name:"Write JSON file with all folders and non-MD files to disk.",callback:()=>{this.methods.writeAllExceptMd(this.settings.allExceptMdFile)}}),this.addCommand({id:"write-canvas-json",name:"Write JSON file with all canvases to disk.",callback:()=>{this.methods.writeCanvases(this.settings.canvasFile)}}),this.addSettingTab(new x(this.app,this)),this.settings.writeFilesOnLaunch&&this.app.workspace.onLayoutReady(()=>{this.methods.writeTagsToJSON(this.settings.tagFile),this.methods.writeCacheToJSON(this.settings.metadataFile),this.methods.writeAllExceptMd(this.settings.allExceptMdFile),this.methods.writeCanvases(this.settings.canvasFile)}),this.methods.setWritingSchedule(this.settings.tagFile,this.settings.metadataFile,this.settings.allExceptMdFile,this.settings.canvasFile)}onunload(){console.log("unloading Metadata Extractor plugin")}async loadSettings(){this.settings=Object.assign({},M,await this.loadData())}async saveSettings(){await this.saveData(this.settings)}};0&&(module.exports={});
